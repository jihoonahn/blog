<!DOCTYPE html><html lang="en"><head><title>JiHoonAHN-Blog - iOS Developer</title><meta name="twitter:title" content="JiHoonAHN-Blog - iOS Developer"/><meta name="og:title" content="JiHoonAHN-Blog - iOS Developer"/><meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" type="image/x-icon" href="/images/Icon/icon.svg"/><script src="https://kit.fontawesome.com/662f6d0c39.js" crossorigin="anonymous"></script><script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><link rel="stylesheet" href="/theme/default/default_style.css"/><link rel="stylesheet" href="/theme/header/header_style.css"/><link rel="stylesheet" href="/theme/footer/footer_style.css"/><link rel="stylesheet" href="/theme/home/home_style.css"/><link rel="stylesheet" href="/theme/post/post_style.css"/><link rel="stylesheet" href="/theme/tag/tag_style.css"/><link rel="stylesheet" href="/theme/tagDetail/tagDetail_style.css"/><link rel="stylesheet" href="/theme/page/debate/debate_style.css"/><link rel="stylesheet" href="/theme/page/about/about_style.css"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet"/></head><body><div class="home-template has-cover"><div class="viewport"><header id="blog-head" class="blog-head outer"><nav class="blog-head-inner inner"><div class="blog-head-brand"><a class="blog-head-logo" href="/"><img src="/images/logo/logo.svg"/></a><div class="blog-head-brand-wrapper"><button class="blog-search"><i class="fa-solid fa-magnifying-glass"></i></button><button class="blog-menu"><i class="fa-regular fa-bars"></i></button></div></div><div class="blog-head-menu"><ul class="nav"><li class="nav-item"><a href="/">Home</a></li><li class="nav-item"><a href="/debate">Debate</a></li><li class="nav-item"><a href="/about">About</a></li></ul></div><div class="blog-head-actions"><button class="blog-search"><i class="fa-solid fa-magnifying-glass"></i></button></div></nav><script src="/js/Header/header-menu.js" defer></script><script src="/js/Header/header-scroll.js" defer></script></header><article><header class="site-post-head"><div class="site-post-head-image"><img src="/images/Image/posts/13.jpg"/></div></header><div class="site-post-head-title"><h1>Building a real-world iOS app (Part 3): Fetching and parsing data from API</h1><section class="site-post-full-meta"><time>2019.03.18</time><span class="date-divider">|</span><a href="/tags/debate">Debate. </a></section></div><div class="site-post-body"><div><p>In the <a href="2019-03-17-aerogami_series_part_2">previous part</a> we discovered a way to separate our application into frameworks and setup the architecture of our app to support dependency injection. In this part of the series we'll be fetching and parsing data from the backend using Alamofire and Codable.</p><h1>API Client</h1><p>Although in the scope of this tutorial we'll be using mocked data, the application will be completely ready to support calls to REST APIs.</p><h3>Protocol</h3><p>We define our <a href="https://github.com/staskus/aerogami-ios/blob/master/TravelAPIKit/APIClient.swift">APIClient</a> protocol that serves as a lean interface between data fetching classes and actual implementation.</p><pre><code><span class="keyword">import</span> RxSwift

<span class="keyword">public protocol</span> APIClient {
    <span class="keyword">func</span> get(path: <span class="type">String</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">Any</span>&gt;
}
</code></pre><p>It returns <code>Observable&lt;Any&gt;</code> which is a part of <code>RxSwift</code>. We won't be going through the basics of <code>RxSwift</code>, so it's beneficial to take a look <a href="https://github.com/ReactiveX/RxSwift">official documentation</a> before continuing.</p><h3>Implementation</h3><p>The actual implementation is in <a href="https://github.com/staskus/aerogami-ios/blob/master/TravelAPIKit/BaseAPIClient.swift">BaseAPIClient</a>, which uses <a href="https://github.com/Alamofire/Alamofire">Alamofire</a> for making HTTP requests. The only method <code>get(path: String)</code> makes <code>GET</code> request by concating given path to a base URL.</p><pre><code><span class="keyword">import</span> RxAlamofire
<span class="keyword">import</span> RxSwift

<span class="keyword">public class</span> BaseAPIClient: <span class="type">APIClient</span> {
    <span class="keyword">private let</span> baseUrl: <span class="type">String</span>

    <span class="keyword">public init</span>(baseUrl: <span class="type">String</span>) {
        <span class="keyword">self</span>.<span class="property">baseUrl</span> = baseUrl
    }

    <span class="keyword">public func</span> get(path: <span class="type">String</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">Any</span>&gt; {
        <span class="keyword">return</span> <span class="type">RxAlamofire</span>
            .<span class="call">requestJSON</span>(.<span class="dotAccess">get</span>, <span class="string">"</span>\(baseUrl)<span class="string">/</span>\(path)<span class="string">"</span>)
            .<span class="call">map</span> { $1 }
    }
}
</code></pre><h3>Mock</h3><p>If you clone the <a href="https://github.com/staskus/aerogami-ios">repository</a>, it will use <a href="https://github.com/staskus/aerogami-ios/blob/master/TravelAPIKit/BaseAPIClient.swift">MockAPIClient</a> which takes data from files. Because it uses the same public interface, <code>MockAPIClient</code> and <code>BaseAPIClient</code> can be interchanged depending on needs. See <a href="https://github.com/staskus/aerogami-ios/blob/bd558d5962e7d97300213ad6896ff8d1f548a074/TravelApplication/Application/Assembly/ApplicationAssembly.swift">ApplicationAssembly</a> which assigns dependencies for <code>APIClient</code> interface. Depending on different configuration, it can assign any of these two. This little example perfectly illustrates the power of <code>dependency injection</code> and usage of <code>protocols</code>.</p><h1>Data</h1><p>The main entity in this project is a <code>Trip</code>. It describes the origin and destination of the flight as well as price and dates.</p><pre><code>{
   <span class="string">"currency"</span>:<span class="string">"EUR"</span>,
   <span class="string">"created_at"</span>:<span class="number">1547991979887</span>,
   <span class="string">"airlines"</span>:<span class="string">"FR"</span>,
   <span class="string">"departure_at"</span>:<span class="number">1552848000000</span>,
   <span class="string">"destination"</span>:{
      <span class="string">"city"</span>:<span class="string">"Malaga"</span>,
      <span class="string">"country_code"</span>:<span class="string">"ES"</span>,
      <span class="string">"airport_code"</span>:<span class="string">"AGP"</span>
   },
   <span class="string">"flight_number"</span>:<span class="number">4048</span>,
   <span class="string">"departure"</span>:{
      <span class="string">"city"</span>:<span class="string">"Copenhagen"</span>,
      <span class="string">"country_code"</span>:<span class="string">"DK"</span>,
      <span class="string">"airport_code"</span>:<span class="string">"CPH"</span>
   },
   <span class="string">"return_at"</span>:<span class="number">1553153100000</span>,
   <span class="string">"price"</span>:<span class="number">72</span>,
   <span class="string">"id"</span>:<span class="string">"c4449ff0-1cb9-11e9-b9f8-b3ba95b35000"</span>,
   <span class="string">"expires_at"</span>:<span class="number">1739200281000</span>
}
</code></pre><p><a href="https://github.com/staskus/aerogami-ios/blob/master/TravelApplication/Application/Mocking/TripMock.json">See full Trips JSON file</a></p><p>We'll define our entities inside <code>TravelKit</code> framework. They should be made public, so they could be reached inside other frameworks. We'll use excellent <a href="https://developer.apple.com/documentation/swift/codable">Codable</a> type that starting from Swift 4 provides a powerful and clean way to encode and decode data.</p><p>Take a look at <a href="https://github.com/staskus/aerogami-ios/blob/master/TravelKit/Repositories/Trip/Trip.swift">Trip</a> class. We don't need to define keys of each values if they match. It's possible to define what naming strategies are used during decoding or encoding process. For example, <code>.convertFromSnakeCase</code> strategy, as its name suggests, converts keys from snake case and assigns values automatically if they match.</p><pre><code><span class="keyword">import</span> Foundation

<span class="keyword">public struct</span> Trip: <span class="type">Codable</span>, <span class="type">Equatable</span> {
    <span class="keyword">public var</span> id: <span class="type">String</span> = <span class="string">""</span>
    <span class="keyword">public var</span> currency: <span class="type">String</span> = <span class="string">""</span>
    <span class="keyword">public var</span> price = <span class="number">0</span>

    <span class="keyword">public var</span> airlines = <span class="string">""</span>
    <span class="keyword">public var</span> flightNumber = <span class="number">0</span>

    <span class="keyword">public var</span> destination: <span class="type">TripLocation</span>!
    <span class="keyword">public var</span> departure: <span class="type">TripLocation</span>!

    <span class="keyword">public var</span> createdAt = <span class="type">Date</span>()
    <span class="keyword">public var</span> departureAt = <span class="type">Date</span>()
    <span class="keyword">public var</span> returnAt = <span class="type">Date</span>()
    <span class="keyword">public var</span> expiresAt = <span class="type">Date</span>()

    <span class="keyword">public init</span>() {}
}

<span class="keyword">public struct</span> TripLocation: <span class="type">Codable</span>, <span class="type">Equatable</span> {
    <span class="keyword">public var</span> city: <span class="type">String</span>!
    <span class="keyword">public var</span> countryCode: <span class="type">String</span>!
    <span class="keyword">public var</span> airportCode: <span class="type">String</span>!

    <span class="keyword">public init</span>() {}
}
</code></pre><p>After receiving <code>JSON</code> data we can define <code>decoder</code> and automatically parse values.</p><pre><code>     <span class="keyword">public static var</span> decoder: <span class="type">JSONDecoder</span> = {
        <span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()
        decoder.<span class="property">keyDecodingStrategy</span> = .<span class="dotAccess">convertFromSnakeCase</span>
        decoder.<span class="property">dateDecodingStrategy</span> = .<span class="dotAccess">millisecondsSince1970</span>
        <span class="keyword">return</span> decoder
    }()

    <span class="keyword">let</span> trips = <span class="keyword">try</span>? decoder.<span class="call">decode</span>([<span class="type">Trip</span>].<span class="keyword">self</span>, from: data)
</code></pre><p>With this simple and straightforward Codable API our data is cleanly parsed into statically typed object or array of objects after <a href="https://github.com/staskus/aerogami-ios/blob/master/TravelDataKit/Repositories/Trip/Remote/APITripDataStore.swift">fetching from API</a>.</p><h1>Repositories</h1><p>Classes that are used to fetch data will be called repositories. In <code>TravelKit</code> we'll only define the protocols of these repositories. Our UI framework <code>TravelFeatureKit</code> will only know about <code>TravelKit</code> and protocols of repositories thus the implementations, defined in <code>TravelDataKit</code>, will be easily changeable.</p><p>Our <code>TripRepository</code> protocol defines the only way to fetch trips.</p><pre><code><span class="keyword">import</span> RxSwift

<span class="keyword">public protocol</span> TripRepository {
    <span class="keyword">func</span> getTrips(in region: <span class="type">String</span>?) -&gt; <span class="type">Observable</span>&lt;[<span class="type">Trip</span>]&gt;
}
</code></pre><p>Because our UI framework will only know about this protocol, we will be able to provide different types of implementations. <a href="https://github.com/staskus/aerogami-ios/blob/bd558d5962e7d97300213ad6896ff8d1f548a074/TravelDataKit/Repositories/Trip/TripRepository.swift">TripRepository</a> implementation defined in <code>TravelDataKit</code> calls the <code>API</code> to fetch data and parses it using <code>Coadable</code>. However, <a href="https://github.com/staskus/aerogami-ios/blob/bd558d5962e7d97300213ad6896ff8d1f548a074/TravelDataKit/Repositories/Trip/FavoriteTripRepository.swift">FavoriteTripRepository</a> which also implements <code>TripRepository</code> interface, uses <code>UserDefaults</code> to fetch locally liked <code>Trips</code>. It allows us to generate 2 completely different screens in our app. One showing the current feed of flights fetched from the API and another of liked and locally saved trips. Here <a href="https://github.com/staskus/aerogami-ios/blob/bd558d5962e7d97300213ad6896ff8d1f548a074/TravelFeatureKit/Features/Favorites/FavoritesAssembly.swift">FavoritesAssembly</a> simply injects necessary dependencies needed for <em>favorites</em> to a <code>FavoriteFeed</code> feature.</p><h1>Design</h1><p>Before continuing creating the app, we'll see how we can quickly create simple application designs using Sketch or similar tools. In the next part of the series we'll overview the approach.</p></div></div><script src="https://utteranc.es/client.js" repo="JiHoonAHN/Blog" issue-term="pathname" label="comments" theme="github-light" crossorigin="anonymous" async></script></article><footer class="site-footer outer"><div class="inner"><section class="copyright"><a href="https://github.com/Pelagornis">Pelagornis</a> Â© 2022</section><nav class="site-footer-nav"><ul class="nav"><li class="nav-list-item"><a href="/">Home</a></li><li class="nav-list-item"><a href="/debate">Debate</a></li><li class="nav-list-item"><a href="/about">About</a></li></ul></nav><ul class="site-footer-social-list"><li class="site-footer-social-list-item"><a href="https://github.com/JiHoonAHN"><i class="fab fa-github-square"></i></a></li><li class="site-footer-social-list-item"><a href="mailto:ahnjh1028@naver.com"><i class="fas fa-envelope-open-text"></i></a></li></ul></div></footer></div></div></body></html>